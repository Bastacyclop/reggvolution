use reggvolution::*;
use egg::*;

fn main() {
  let mm: RiseExpr = "(typeOf (lam (typeOf (lam (typeOf (lam (typeOf (lam (typeOf (lam (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT %2) f32)) (app (app arrT %3) f32))) (app (app fun (app (app arrT %4) (app (app arrT %2) f32))) (app (app arrT %4) (app (app arrT %3) f32))))) (typeOf (lam (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT %3) f32)) f32)) (app (app fun (app (app arrT %4) (app (app arrT %3) f32))) (app (app arrT %4) f32)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf (app (typeOf reduce (app (app fun (app (app fun f32) (app (app fun f32) f32))) (app (app fun f32) (app (app fun (app (app arrT %4) f32)) f32)))) (typeOf add (app (app fun f32) (app (app fun f32) f32)))) (app (app fun f32) (app (app fun (app (app arrT %4) f32)) f32))) (typeOf 0.0 f32)) (app (app fun (app (app arrT %4) f32)) f32)) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app pairT f32) f32)) f32)) (app (app fun (app (app arrT %4) (app (app pairT f32) f32))) (app (app arrT %4) f32)))) (typeOf (lam (typeOf (app (typeOf (app (typeOf mul (app (app fun f32) (app (app fun f32) f32))) (typeOf (app (typeOf fst (app (app fun (app (app pairT f32) f32)) f32)) (typeOf %3 (app (app pairT f32) f32))) f32)) (app (app fun f32) f32)) (typeOf (app (typeOf snd (app (app fun (app (app pairT f32) f32)) f32)) (typeOf %3 (app (app pairT f32) f32))) f32)) f32)) (app (app fun (app (app pairT f32) f32)) f32))) (app (app fun (app (app arrT %4) (app (app pairT f32) f32))) (app (app arrT %4) f32))) (typeOf (app (typeOf (app (typeOf zip (app (app fun (app (app arrT %4) f32)) (app (app fun (app (app arrT %4) f32)) (app (app arrT %4) (app (app pairT f32) f32))))) (typeOf %4 (app (app arrT %4) f32))) (app (app fun (app (app arrT %4) f32)) (app (app arrT %4) (app (app pairT f32) f32)))) (typeOf %3 (app (app arrT %4) f32))) (app (app arrT %4) (app (app pairT f32) f32)))) (app (app arrT %4) f32))) f32)) (app (app fun (app (app arrT %3) f32)) f32))) (app (app fun (app (app arrT %4) (app (app arrT %3) f32))) (app (app arrT %4) f32))) (typeOf (app (typeOf transpose (app (app fun (app (app arrT %3) (app (app arrT %4) f32))) (app (app arrT %4) (app (app arrT %3) f32)))) (typeOf %4 (app (app arrT %3) (app (app arrT %4) f32)))) (app (app arrT %4) (app (app arrT %3) f32)))) (app (app arrT %4) f32))) (app (app fun (app (app arrT %2) f32)) (app (app arrT %3) f32)))) (app (app fun (app (app arrT %4) (app (app arrT %2) f32))) (app (app arrT %4) (app (app arrT %3) f32)))) (typeOf %4 (app (app arrT %4) (app (app arrT %2) f32)))) (app (app arrT %4) (app (app arrT %3) f32)))) (app (app fun (app (app arrT %1) (app (app arrT %2) f32))) (app (app arrT %3) (app (app arrT %2) f32))))) (app (app fun (app (app arrT %2) (app (app arrT %0) f32))) (app (app fun (app (app arrT %0) (app (app arrT %1) f32))) (app (app arrT %2) (app (app arrT %1) f32)))))) (lam (app (app fun (app (app arrT %2) (app (app arrT %0) f32))) (app (app fun (app (app arrT %0) (app (app arrT %1) f32))) (app (app arrT %2) (app (app arrT %1) f32))))))) (lam (lam (app (app fun (app (app arrT %2) (app (app arrT %0) f32))) (app (app fun (app (app arrT %0) (app (app arrT %1) f32))) (app (app arrT %2) (app (app arrT %1) f32)))))))) (lam (lam (lam (app (app fun (app (app arrT %2) (app (app arrT %0) f32))) (app (app fun (app (app arrT %0) (app (app arrT %1) f32))) (app (app arrT %2) (app (app arrT %1) f32))))))))".parse().unwrap();

  let rules: Vec<RiseRewrite> = vec![
    rewrite!("reduce-seq"; "(typeOf reduce (app (app fun (app (app fun ?dt0) (app (app fun ?dt0) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt0)) ?dt0))))" => "(typeOf reduceSeq (app (app fun (app (app fun ?dt0) (app (app fun ?dt0) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt0)) ?dt0))))"),
    rewrite!("eliminate-map-identity"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf %0 ?)) (app (app fun ?dt0) ?dt0))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0)))" => "(typeOf (lam (typeOf %0 (app (app arrT ?n0) ?dt0))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0)))"),
    rewrite!("eliminate-map-identity"; "(typeOf (app (typeOf map ?) (typeOf (lam (typeOf %0 ?)) (app (app fun ?dt0) ?dt0))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0)))" => "(typeOf (lam (typeOf %0 (app (app arrT ?n0) ?dt0))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0)))"),
    rewrite!("transpose-around-map-map-f-1m"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) ?) (typeOf ?e1 (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))" => "(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))))) (typeOf transpose (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt1))) (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (typeOf (app (typeOf map (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt1)))) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt1)))) (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))))) (typeOf transpose (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))))) (typeOf ?e1 (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))"),
    rewrite!("store-to-mem"; "(typeOf ?e0 ?dt0)" => "(typeOf (app (typeOf (app (typeOf let (app (app fun ?dt0) (app (app fun (app (app fun ?dt0) ?dt0)) ?dt0))) (typeOf (app (typeOf toMem (app (app fun ?dt0) ?dt0)) (typeOf ?e0 ?dt0)) ?dt0)) (app (app fun (app (app fun ?dt0) ?dt0)) ?dt0)) (typeOf (lam (typeOf %0 ?dt0)) (app (app fun ?dt0) ?dt0))) ?dt0)"),
    rewrite!("map-array"; "(typeOf ?e0 (app (app arrT ?n0) ?dt0))" => "(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun ?dt0) ?dt0)) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0)))) (typeOf (lam (typeOf %0 ?dt0)) (app (app fun ?dt0) ?dt0))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt0))) (typeOf ?e0 (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) ?dt0))"),
    rewrite!("transpose-around-map-map-f-1m"; "(typeOf (app (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf (app (typeOf map ?) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) ?) (typeOf ?e1 (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))" => "(typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1)))))) (typeOf transpose (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1)))))) (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt1))) (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (typeOf (app (typeOf map (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt1)))) (typeOf ?e0 (app (app fun ?dt0) ?dt1))) (app (app fun (app (app arrT ?n1) ?dt0)) (app (app arrT ?n1) ?dt1)))) (app (app fun (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (typeOf (app (typeOf (app (typeOf map (app (app fun (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0)))))) (typeOf transpose (app (app fun (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))))) (app (app fun (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0)))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))))) (typeOf ?e1 (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt0))))) (app (app arrT ?n2) (app (app arrT ?n0) (app (app arrT ?n1) ?dt1))))) (app (app arrT ?n2) (app (app arrT ?n1) (app (app arrT ?n0) ?dt1))))"),
    rewrite!("reduce-seq-unroll"; "(typeOf reduceSeq (app (app fun (app (app fun ?dt0) (app (app fun ?dt1) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt1)) ?dt0))))" => "(typeOf reduceSeqUnroll (app (app fun (app (app fun ?dt0) (app (app fun ?dt1) ?dt0))) (app (app fun ?dt0) (app (app fun (app (app arrT ?n0) ?dt1)) ?dt0))))"),
    rewrite!("map-par"; "(typeOf map (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1))))" => "(typeOf mapPar (app (app fun (app (app fun ?dt0) ?dt1)) (app (app fun (app (app arrT ?n0) ?dt0)) (app (app arrT ?n0) ?dt1))))"),
  ];

  println!("{}", mm.pretty(80));
  println!("{}", rules.len());
}